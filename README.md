# BondBuddy — Ktor Server

Этот репозиторий содержит исходный код серверной части приложения **BondBuddy**, разработанной с использованием Kotlin и фреймворка **Ktor**. Сервер реализует **REST API** для управления пользователями, аутентификации, подбора собеседников, работы с интересами и взаимодействия с базой данных **PostgreSQL**. Дополнительно используется отдельный Python-сервис на базе Flask, реализующий рекомендации по смысловому сходству на основе модели `SentenceTransformer`.


## Требования

- JDK 20+
- Gradle
- Docker и Docker Compose — для запуска PostgreSQL и Flask-сервиса
- PostgreSQL 15+ (если не используется Docker)


## Развертывание

### 1. Клонирование проекта

```bash
git clone git@github.com:roegic/backend-ktor.git
cd backend-ktor
```

### 2. Запуск PostgreSQL и Flask-сервиса через Docker Compose

```bash
docker-compose up --build
```
Этот шаг поднимает два основных сервиса:

**PostgreSQL (db)** — база данных, в которой хранятся пользователи, интересы, теги и другая информация. Ktor-сервер использует её для выполнения CRUD-операций, а также для анализа общих интересов между пользователями.

**Flask-сервис** — отвечает за рекомендации. Он принимает список пользователей с их биографией, интересами и родом деятельности, и возвращает наиболее релевантных по смысловому сходству. Алгоритм работает так:

1. Собирается текстовое представление каждого пользователя.
2. Эти тексты кодируются в векторные эмбеддинги с помощью SentenceTransformer.
3. Вычисляется косинусное сходство между пользователями.
4. Возвращается список наиболее похожих пользователей с оценкой схожести (score).

### 3. Запуск сервера

```bash
./gradlew run
```

После запуска Ktor-сервер начинает слушать входящие HTTP-запросы на определённом порту (по умолчанию 8080). Он предоставляет REST API для:

- Регистрации и аутентификации пользователей
- Управления интересами и тегами
- Поиска и подбора подходящих собеседников
- Отправки запросов на рекомендации (в том числе с передачей данных во Flask-сервис)

**Взаимодействие с Flask-сервисом:**
1. Из базы данных получаются все пользователи с их интересами (тегами).
2. Формируется JSON-запрос с био, интересами и профессией пользователей.
3. Этот JSON отправляется POST-запросом во Flask-сервис по адресу `http://localhost:8085/recommendations_with_scores/`.
4. Flask возвращает косинусные оценки сходства между пользователями на основе смыслового анализа текста.

**Расчет общей оценки:**
```python
TotalScore = α * TagMatchScore + β * CosineScore
```

Где:

*   `TagMatchScore` - количество общих тегов между пользователями.
*   `CosineScore` - смысловая близость из Flask-сервиса.
*   `α` - настраиваемый вес для `TagMatchScore` (по умолчанию 0.6).
*   `β` - настраиваемый вес для `CosineScore` (по умолчанию 0.4).

Пользователи сортируются по `TotalScore` в убывающем порядке, и возвращается список рекомендаций.

## Переменные окружения (опционально)

Для настройки подключения к базе данных и обеспечения безопасности рекомендуется использовать переменные окружения. Если переменные окружения не заданы, будут использованы значения по умолчанию.

Следующие переменные окружения могут быть настроены:
*   `DATABASE_URL`: URL для подключения к базе данных PostgreSQL.
*   `DATABASE_USER`: Имя пользователя для подключения к базе данных PostgreSQL.
*   `DATABASE_PASSWORD`: Пароль для подключения к базе данных PostgreSQL.
*   `JDBC_DRIVER`: Драйвер JDBC для PostgreSQL. 
*   `JWT_SECRET`: Секретный ключ для подписи JWT-токенов.  Рекомендуется использовать сложную и случайную строку.
*   `HASH_SECRET_KEY`: Секретный ключ, используемый для хеширования паролей. Рекомендуется использовать сложную и случайную строку.